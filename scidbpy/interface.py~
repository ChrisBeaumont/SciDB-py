"""
Low-level interface to Scidb
"""
import urllib2
import requests


class SciDBInterface(object):
    pass


class ShimSciDBInterface(SciDBInterface):
    """HTTP interface to SciDB via shim

    """
    def __init__(self, hostname):
        self.hostname = hostname.rstrip('/')

    def _url(self, keyword, **kwargs):
        return (self.hostname + '/' + keyword +
                '&'.join([''] + ['{0}={1}'.format(key, val)
                                 for key, val in kwargs.iteritems()]))

    def _new_session(self):
        """Request a new HTTP session from the service"""
        url = self._url('new_session')
        result = urllib2.urlopen(url)
        session_id = int(result.read())
        return session_id

    def _release_session(self, session_id):
        url = self._url('release_session', id=session_id)
        result = urllib2.urlopen(url)

    def _execute_query(self, session_id, query, save=None, release=False):
        url = self._url('execute_query',
                        id=session_id,
                        query=query,
                        release=int(bool(release)),
                        save=save)
        if save is not None:
            url += "&save={0}".format(save)
        
        result = urllib2.urlopen(url)
        query_id = result.read()
        return query_id

    def _cancel(self, session_id):
        url = self._url('cancel', id=session_id)
        
    def _read_lines(self, session_id, n):
        url = self._url('read_lines', id=session_id, n=n)
        result = urllib2.urlopen(url)
        text_result = result.read()
        return text_result

    def _read_bytes(self, session_id, n):
        url = self._url('read_lines', id=session_id, n=n)
        result = urllib2.urlopen(url)
        bytes_result = result.read()
        return bytes_result

    def _upload_file(self, session_id, filename, data):
        url = self._url('upload_file', id=session_id)
        result = requests.post(url, files={filename:data})
        scidb_filename = result.text
        return scidb_filename
